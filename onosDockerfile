ARG IMAGE_TARGET=alpine
#### Taken from official onosproject github and inserted commands to inject custom app TODO: Attribution, Readme, etc. ####
# First stage is the provider for compiled onos
FROM onosproject/onos:1.13.2 as provider

#### Second stage is the vessel for distribution ####
FROM ${IMAGE_TARGET}

# Change to /root directory, install jdk and maven
RUN apk update && \
        apk add curl && \
        apk add --no-cache openjdk8 && \
        apk add --no-cache maven && \
        apk add --update bash && rm -rf /var/cache/apk/* && \
        mkdir -p /root/onos
WORKDIR /root/onos

# Install ONOS
COPY --from=provider /root/onos/ .
# Install and compile custom app
COPY onosApp/ioannidis.onosApp /root/onos/project.ioannidis.onosApp/
RUN cd /root/onos/project.ioannidis.onosApp && mvn clean install
RUN ["chmod", "+x", "/root/onos/project.ioannidis.onosApp/startupAndInstall"]

# Configure ONOS to log to stdout
RUN sed -ibak '/log4j.rootLogger=/s/$/, stdout/' $(ls -d apache-karaf-*)/etc/org.ops4j.pax.logging.cfg

LABEL org.label-schema.name="ONOS" \
      org.label-schema.description="SDN Controller" \
      org.label-schema.usage="http://wiki.onosproject.org" \
      org.label-schema.url="http://onosproject.org" \
      org.label-scheme.vendor="Open Networking Foundation" \
      org.label-schema.schema-version="1.0"

# Ports
# 6653 - OpenFlow
# 6640 - OVSDB
# 8181 - GUI
# 8101 - ONOS CLI
# 9876 - ONOS intra-cluster communication
EXPOSE 6653 6640 8181 8101 9876

# Get ready to run command
ENTRYPOINT ["/root/onos/project.ioannidis.onosApp/startupAndInstall"]
